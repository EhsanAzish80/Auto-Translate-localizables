name: Auto-Translate Localizations

on:
  # Trigger when English localization changes
  push:
    paths:
      - '**/en.xcloc/**'
      - 'localization/en.xcloc/**'
  
  # Allow manual triggering with options
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to translate (space-separated, e.g., "de fr es") or "all"'
        required: false
        default: 'all'
      only_missing:
        description: 'Only translate missing strings'
        type: boolean
        required: false
        default: true
      create_pr:
        description: 'Create Pull Request (false = direct commit)'
        type: boolean
        required: false
        default: true

jobs:
  translate:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install auto-translate-localizables
        run: |
          # Install from the package in this repo
          pip install -e .
          # Verify installation
          auto-translate-xcloc --version
      
      - name: Find localization workspace
        id: find_workspace
        run: |
          # Look for common localization directory locations
          if [ -d "localization" ]; then
            echo "workspace=localization" >> $GITHUB_OUTPUT
          elif [ -d "Localization" ]; then
            echo "workspace=Localization" >> $GITHUB_OUTPUT
          elif [ -d ".xcloc" ]; then
            echo "workspace=." >> $GITHUB_OUTPUT
          else
            # Find first directory containing .xcloc folders
            xcloc_dir=$(find . -maxdepth 2 -name "*.xcloc" -type d | head -1)
            if [ -n "$xcloc_dir" ]; then
              workspace=$(dirname "$xcloc_dir")
              echo "workspace=$workspace" >> $GITHUB_OUTPUT
            else
              echo "Error: No .xcloc folders found"
              echo "Searched in: $(pwd)"
              echo "Directory contents:"
              ls -la
              exit 1
            fi
          fi
      
      - name: Translate localization files
        run: |
          workspace="${{ steps.find_workspace.outputs.workspace }}"
          echo "Using workspace: $workspace"
          
          # Build command based on inputs
          cmd="auto-translate-xcloc --workspace $workspace"
          
          # Add language filter
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.languages }}" != "all" ]; then
              cmd="$cmd --only ${{ github.event.inputs.languages }}"
            fi
            if [ "${{ github.event.inputs.only_missing }}" = "true" ]; then
              cmd="$cmd --only-missing"
            fi
          else
            # On push, only translate missing strings by default
            cmd="$cmd --only-missing"
          fi
          
          # Always skip English and fail on placeholder mismatch for safety
          cmd="$cmd --skip en --fail-on-placeholder-mismatch"
          
          echo "Running: $cmd"
          $cmd
      
      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
      
      - name: Create Pull Request
        if: |
          steps.changes.outputs.has_changes == 'true' && 
          (github.event_name != 'workflow_dispatch' || github.event.inputs.create_pr == 'true')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            üåç Auto-translate localization files
            
            - Updated translations for modified strings
            - Validated placeholder preservation
            - Ready for review
          title: "üåç Update translations"
          body: |
            ## ü§ñ Automated Translation Update
            
            This PR was automatically generated by the translation workflow.
            
            ### What changed
            - **Trigger:** ${{ github.event_name == 'push' && 'English localization files updated' || 'Manual workflow dispatch' }}
            - **Action:** Machine translation via Google Translate
            - **Validation:** ‚úÖ All placeholders validated and preserved
            
            ### Modified files
            ${{ steps.changes.outputs.has_changes == 'true' && 'See commit for details' || 'None' }}
            
            ### Review checklist
            - [ ] Review translated strings for accuracy
            - [ ] Verify placeholders are preserved correctly
            - [ ] Test in app to verify UI displays correctly
            - [ ] Consider native speaker review for critical strings
            
            ### ‚ö†Ô∏è Quality Note
            These are **machine translations** from Google Translate. Consider professional review for:
            - User-facing UI text
            - Marketing copy
            - Legal or compliance text
            - Brand-critical messaging
            
            ---
            <sub>Generated by [auto-translate-localizables](https://github.com/EhsanAzish80/Auto-Translate-localizables)</sub>
          branch: auto-translations-${{ github.run_number }}
          delete-branch: true
          labels: |
            localization
            automated
            needs-review
      
      - name: Direct commit (if no PR requested)
        if: |
          steps.changes.outputs.has_changes == 'true' && 
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.create_pr == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "üåç Auto-update translations

          Triggered by: manual workflow dispatch
          Languages: ${{ github.event.inputs.languages }}
          Only missing: ${{ github.event.inputs.only_missing }}"
          git push
      
      - name: Summary
        if: always()
        run: |
          echo "## Translation Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace:** ${{ steps.find_workspace.outputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Languages:** ${{ github.event.inputs.languages }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Only missing:** ${{ github.event.inputs.only_missing }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Create PR:** ${{ github.event.inputs.create_pr }}" >> $GITHUB_STEP_SUMMARY
          fi
